<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
	<meta charset="utf-8" />
	<title>浏览器检测</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="format-detection" content="telephone=no" />
	<style>
	body{max-width:640px;margin:0 auto;background:#F1F1F2;font-family: Helvetica, STHeiti STXihei, Microsoft JhengHei, Microsoft YaHei, Arial;font-size:14px;padding:10px;}
	p{margin:0;padding:0;}
	a{color:#666;}
	div{margin:20px 0;}
	h1{font-size:20px;}
	h2, p{font-size:14px;}
	h2{color:#999;font-weight:normal;}
	</style>
</head>
<!-- 注：加ontouchstart使css：active生效 -->
<body ontouchstart="">
	<input type="number" placeholder="浏览器检测结果编号" required />
	<script src="js/zepto.js"></script>
	<script>
	$(function(exports, P){
        'use strict';
        //数据块
        var dataBox ={
            //数据源
            //getDataUrl : 'http://db.qiang.it/api.php?xn=mobilebugs&xk=&act=list',
            getDataUrl : 'http://db.qiang.it/api.php?',
            //业务名称
            dataXn : 'mobilebugs'
        } 

        var waterfall = {
            //数据源
            getDataUrl : dataBox.getDataUrl,
            //业务名称
            dataXn : dataBox.dataXn,
            //数据编号
            dataXk : 0,
            uaData : {
                width:0,
                height:0,
                dpr:0,
                ua:'',
                browser:'',
                engine:'',
                os:'',
                device:'',
                cpu:'',
                nettype:''
            },

            init: function(){
                //this.getNumber();
                var num = this.setNum();
                this.dataXk = num;
                document.getElementById('num').innerText = num;
                this.updateLink(this.uaInfo);
                //this.addData(num);
            },

            getNumber: function(){
                $.ajax({
                    type:'GET',
                    url:this.getUrl(this.getDataUrl,this.dataXn,'','list'),
                    dataType:'json',
                    success:function(data){
                        var dataTotal = data.info.length;
                        var number = dataTotal + 1;
                        document.getElementById('num').innerText = number;
                        waterfall.addData(number);
                    }
                });
            },

            getUrl: function(url, xn, xk, act){
                return url+'xn='+xn+'&xk='+xk+'&act='+act;
            },

            addData: function(num){
                $.ajax({
                    type:'POST',
                    url:this.getUrl(this.getDataUrl,this.dataXn,num,'add'),
                    data:this.generateUaData(),
                    dataType:'json'
                });
            },

            generateUaData: function(){
                this.getSize();
                this.updateBreakdown(this.uaInfo);
                this.getNetType(this.uaInfo);
                return JSON.stringify(this.uaData);
            },

            getSize: function(){
                var width = document.documentElement.clientWidth;
                var height = document.documentElement.clientHeight;
                var dpr = window.devicePixelRatio;
                this.uaData.width=width;
                this.uaData.height=height;
                this.uaData.dpr=dpr;
            },

            updateBreakdown: function(ua) {
                var UAParser = window.uaParserJs;
                var parser = new UAParser(ua);
                var attrs = ['ua', 'browser', 'engine', 'os', 'device', 'cpu'];
                var result = parser.getResult();
                for(var i=0;i<attrs.length;i++){
                    this.uaData[attrs[i]]=result[attrs[i]];
                }
            },

            getNetType: function(ua){
                var nettypeExp = /nettype\//i;
                var uaArr = ua.split(' ');
                var nettype = '';
                for(var i=0;i<uaArr.length;i++){
                    if(uaArr[i].match(nettypeExp)){
                        nettype = uaArr[i].replace(nettypeExp, '');
                    }
                }
                this.uaData.nettype = nettype;
            },

            setNum: function(){
                var now = new Date();
                var month = this.numFix(now.getMonth(),2);
                var day = this.numFix(now.getDay(),2);
                var hours = this.numFix(now.getHours(),2);
                var minutes = this.numFix(now.getMinutes(),2);
                var seconds = this.numFix(now.getSeconds(),2);

                var num = now.getFullYear() + month + day + "-" + hours + minutes + seconds;
                return num;
            },

            numFix: function(digit, bit){
                var digitArr = (digit+"").split("");
                var digitBit = digitArr.length;
                var limit = Math.pow(10, (bit-1));

                if(digitBit >= bit){return digit;}

                if(digit<limit){
                    for(var i=0; i<(bit-digitBit); i++){
                        digitArr.unshift('0');
                    }
                }
                return digitArr.join('');
            }
        }
        waterfall.init();
    });
    </script>
</body>
</html>